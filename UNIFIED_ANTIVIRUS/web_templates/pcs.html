{% extends "base.html" %}

{% block title %}PCs Monitoreadas - Antivirus Web Monitor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-desktop me-2"></i>PCs Monitoreadas</h1>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="refreshData()">
            <i class="fas fa-sync-alt me-1"></i>Actualizar
        </button>
        <button class="btn btn-outline-success" onclick="exportData()">
            <i class="fas fa-download me-1"></i>Exportar
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if pcs %}
        <div class="table-responsive">
            <table class="table table-hover" id="pcsTable">
                <thead class="table-dark">
                    <tr>
                        <th>PC ID</th>
                        <th>Hostname</th>
                        <th>Plataforma</th>
                        <th>IP Address</th>
                        <th>Python Version</th>
                        <th>Total Logs</th>
                        <th>Primer Registro</th>
                        <th>Última Actividad</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pc in pcs %}
                    <tr>
                        <td>
                            <code title="{{ pc.pc_id }}">{{ pc.pc_id[:20] }}{% if pc.pc_id|length > 20 %}...{% endif %}</code>
                        </td>
                        <td>
                            <strong>{{ pc.hostname }}</strong>
                        </td>
                        <td>
                            <small>{{ pc.platform }}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ pc.ip_address }}</span>
                        </td>
                        <td>
                            <small>{{ pc.python_version }}</small>
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ pc.total_logs }}</span>
                        </td>
                        <td>
                            <small>{{ pc.first_seen[:19] }}</small>
                        </td>
                        <td>
                            <small>{{ pc.last_seen[:19] }}</small>
                        </td>
                        <td>
                            {% set last_seen = pc.last_seen | strptime('%Y-%m-%d %H:%M:%S') %}
                            {% set now = moment() %}
                            {% set hours_diff = ((now - last_seen).total_seconds() / 3600) | int %}
                            
                            {% if hours_diff < 1 %}
                                <span class="badge bg-success"><i class="fas fa-circle me-1"></i>Online</span>
                            {% elif hours_diff < 6 %}
                                <span class="badge bg-warning"><i class="fas fa-clock me-1"></i>{{ hours_diff }}h ago</span>
                            {% elif hours_diff < 24 %}
                                <span class="badge bg-warning"><i class="fas fa-clock me-1"></i>{{ hours_diff }}h ago</span>
                            {% else %}
                                <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Offline</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewPCLogs('{{ pc.pc_id }}')" title="Ver logs">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="showPCDetails('{{ pc.pc_id }}')" title="Detalles">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Estadísticas de resumen -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h4 class="text-primary">{{ pcs | length }}</h4>
                        <small class="text-muted">Total PCs</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h4 class="text-success" id="onlinePCs">-</h4>
                        <small class="text-muted">Online</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h4 class="text-warning" id="recentPCs">-</h4>
                        <small class="text-muted">Recientes (24h)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <h4 class="text-danger" id="offlinePCs">-</h4>
                        <small class="text-muted">Offline</small>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-desktop fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">No hay PCs registradas</h4>
            <p class="text-muted">Las PCs aparecerán aquí cuando envíen sus primeros logs al servidor.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para detalles de PC -->
<div class="modal fade" id="pcDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles de PC</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pcDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Calcular estadísticas de estado
document.addEventListener('DOMContentLoaded', function() {
    calculatePCStats();
});

function calculatePCStats() {
    const rows = document.querySelectorAll('#pcsTable tbody tr');
    let online = 0, recent = 0, offline = 0;
    
    rows.forEach(row => {
        const statusBadge = row.querySelector('td:nth-child(9) .badge');
        if (statusBadge) {
            if (statusBadge.classList.contains('bg-success')) online++;
            else if (statusBadge.classList.contains('bg-warning')) recent++;
            else if (statusBadge.classList.contains('bg-danger')) offline++;
        }
    });
    
    document.getElementById('onlinePCs').textContent = online;
    document.getElementById('recentPCs').textContent = recent;
    document.getElementById('offlinePCs').textContent = offline;
}

function refreshData() {
    location.reload();
}

function exportData() {
    // Crear CSV con datos de PCs
    const table = document.getElementById('pcsTable');
    let csv = 'PC ID,Hostname,Plataforma,IP Address,Python Version,Total Logs,Primer Registro,Última Actividad,Estado\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = [
            cells[0].textContent.trim(),
            cells[1].textContent.trim(),
            cells[2].textContent.trim(),
            cells[3].textContent.trim(),
            cells[4].textContent.trim(),
            cells[5].textContent.trim(),
            cells[6].textContent.trim(),
            cells[7].textContent.trim(),
            cells[8].textContent.trim()
        ];
        csv += rowData.join(',') + '\n';
    });
    
    // Descargar archivo
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pcs_monitoreadas_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function viewPCLogs(pcId) {
    // Redirigir a página de logs filtrada por PC
    window.location.href = `/logs?pc_id=${encodeURIComponent(pcId)}`;
}

function showPCDetails(pcId) {
    const modal = new bootstrap.Modal(document.getElementById('pcDetailsModal'));
    const content = document.getElementById('pcDetailsContent');
    
    // Mostrar loading
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Cargar detalles (simulado - en producción sería una llamada AJAX)
    setTimeout(() => {
        content.innerHTML = `
            <h6>PC ID:</h6>
            <p><code>${pcId}</code></p>
            
            <h6>Estadísticas de Logs:</h6>
            <div class="row">
                <div class="col-md-6">
                    <canvas id="pcLogChart" width="200" height="200"></canvas>
                </div>
                <div class="col-md-6">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Logs hoy</span>
                            <span class="badge bg-primary">-</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Promedio diario</span>
                            <span class="badge bg-info">-</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Último error</span>
                            <span class="badge bg-warning">-</span>
                        </li>
                    </ul>
                </div>
            </div>
        `;
    }, 1000);
}

// Auto-refresh cada 60 segundos
setInterval(refreshData, 60000);
</script>
{% endblock %}