{% extends "base.html" %}

{% block title %}Dashboard - Antivirus Web Monitor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
    <div class="text-muted">
        <i class="fas fa-clock me-1"></i>
        <span id="current-time"></span>
    </div>
</div>

<!-- Métricas principales -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <i class="fas fa-list-alt fa-3x mb-3"></i>
                <h3>{{ metrics.total_logs | default(0) }}</h3>
                <p class="mb-0">Total Logs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card success">
            <div class="card-body text-center">
                <i class="fas fa-desktop fa-3x mb-3"></i>
                <h3>{{ metrics.active_pcs | default(0) }}</h3>
                <p class="mb-0">PCs Activas (24h)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card warning">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h3>{{ metrics.log_levels.ERROR | default(0) + metrics.log_levels.CRITICAL | default(0) }}</h3>
                <p class="mb-0">Errores Críticos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card info">
            <div class="card-body text-center">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <h3>{{ metrics.log_levels.WARNING | default(0) }}</h3>
                <p class="mb-0">Advertencias</p>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Actividad de Logs (Últimas 24h)</h5>
            </div>
            <div class="card-body">
                <canvas id="activityChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Distribución por Nivel</h5>
            </div>
            <div class="card-body">
                <canvas id="levelChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- PCs y Logs recientes -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-desktop me-2"></i>PCs Registradas</h5>
                <a href="/pcs" class="btn btn-sm btn-outline-primary">Ver todas</a>
            </div>
            <div class="card-body">
                {% if pcs %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>PC ID</th>
                                <th>Hostname</th>
                                <th>IP</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pc in pcs[:5] %}
                            <tr>
                                <td><small>{{ pc.pc_id[:20] }}...</small></td>
                                <td>{{ pc.hostname }}</td>
                                <td>{{ pc.ip_address }}</td>
                                <td>
                                    <!-- Nota: En producción esto se calculará en el backend -->
                                    <span class="badge bg-success">Online</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No hay PCs registradas aún</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Logs Recientes</h5>
                <a href="/logs" class="btn btn-sm btn-outline-primary">Ver todos</a>
            </div>
            <div class="card-body">
                {% if recent_logs %}
                <div style="max-height: 400px; overflow-y: auto;">
                    {% for log in recent_logs[:10] %}
                    <div class="d-flex justify-content-between align-items-start mb-2 p-2 border-bottom">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="log-level-{{ log.level }}">{{ log.level }}</span>
                                <small class="text-muted ms-2">{{ log.logger }}</small>
                                <small class="text-muted ms-auto">{{ log.timestamp[:19] }}</small>
                            </div>
                            <small class="text-truncate d-block" style="max-width: 300px;" title="{{ log.message }}">
                                {{ log.message }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No hay logs aún</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Top Loggers -->
{% if metrics.top_loggers %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-star me-2"></i>Top Loggers (24h)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for logger in metrics.top_loggers %}
                    <div class="col-md-2 mb-2">
                        <div class="text-center p-2 border rounded">
                            <strong>{{ logger.logger }}</strong><br>
                            <small class="text-muted">{{ logger.count }} logs</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Actualizar tiempo
function updateTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = now.toLocaleString('es-ES');
}
updateTime();
setInterval(updateTime, 1000);

// Cargar datos vía AJAX para evitar problemas con Jinja2
function loadChartData() {
    // Gráfico de actividad con datos de ejemplo
    const activityData = {
        labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
        datasets: [{
            label: 'Logs por Hora',
            data: [12, 19, 25, 45, 38, 22],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            tension: 0.4
        }]
    };
    
    if (document.getElementById('activityChart')) {
        new Chart(document.getElementById('activityChart'), {
            type: 'line',
            data: activityData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Gráfico de niveles con datos de ejemplo
    const levelData = {
        labels: ['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'],
        datasets: [{
            data: [45, 120, 35, 15, 5],
            backgroundColor: ['#6c757d', '#0dcaf0', '#fd7e14', '#dc3545', '#721c24'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };
    
    if (document.getElementById('levelChart')) {
        new Chart(document.getElementById('levelChart'), {
            type: 'doughnut',
            data: levelData,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
}

// Cargar gráficos cuando la página esté lista
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que Chart.js se cargue
    if (typeof Chart !== 'undefined') {
        loadChartData();
    } else {
        setTimeout(loadChartData, 1000);
    }
});

// Auto-refresh cada 30 segundos
setTimeout(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}