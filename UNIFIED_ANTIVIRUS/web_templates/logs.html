{% extends "base.html" %}

{% block title %}Logs - Antivirus Web Monitor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-list-alt me-2"></i>Logs del Sistema</h1>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="refreshLogs()">
            <i class="fas fa-sync-alt me-1"></i>Actualizar
        </button>
        <button class="btn btn-outline-success" onclick="exportLogs()">
            <i class="fas fa-download me-1"></i>Exportar
        </button>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form id="filterForm" class="row g-3">
            <div class="col-md-3">
                <label for="pcFilter" class="form-label">PC</label>
                <select class="form-select" id="pcFilter">
                    <option value="">Todas las PCs</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="levelFilter" class="form-label">Nivel</label>
                <select class="form-select" id="levelFilter">
                    <option value="">Todos</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="searchFilter" class="form-label">Buscar en mensaje</label>
                <input type="text" class="form-control" id="searchFilter" placeholder="Texto a buscar...">
            </div>
            <div class="col-md-2">
                <label for="limitFilter" class="form-label">Mostrar</label>
                <select class="form-select" id="limitFilter">
                    <option value="100">100 registros</option>
                    <option value="500">500 registros</option>
                    <option value="1000">1000 registros</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="button" class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-filter me-1"></i>Filtrar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Tabla de logs -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Logs Registrados</h6>
        <div>
            <span class="badge bg-secondary" id="logCount">Cargando...</span>
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                <i class="fas fa-pause"></i> Auto-refresh
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="logsContainer" style="max-height: 600px; overflow-y: auto;">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando logs...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Paginación -->
<nav aria-label="Paginación de logs" class="mt-3">
    <ul class="pagination justify-content-center" id="pagination">
    </ul>
</nav>

<!-- Modal para detalles de log -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="logDetailsContent">
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentPage = 0;
let autoRefreshEnabled = true;
let autoRefreshInterval;

// Inicializar página
document.addEventListener('DOMContentLoaded', function() {
    loadPCsList();
    loadLogs();
    
    // Configurar auto-refresh
    startAutoRefresh();
    
    // Aplicar filtros desde URL si existen
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('pc_id')) {
        document.getElementById('pcFilter').value = urlParams.get('pc_id');
    }
    if (urlParams.get('level')) {
        document.getElementById('levelFilter').value = urlParams.get('level');
    }
    
    // Aplicar filtros si hay parámetros en URL
    if (urlParams.toString()) {
        setTimeout(applyFilters, 500);
    }
});

function loadPCsList() {
    fetch('/api/pcs')
        .then(response => response.json())
        .then(pcs => {
            const select = document.getElementById('pcFilter');
            pcs.forEach(pc => {
                const option = document.createElement('option');
                option.value = pc.pc_id;
                option.textContent = `${pc.hostname} (${pc.pc_id.substring(0, 8)}...)`;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error cargando PCs:', error));
}

function loadLogs(page = 0) {
    const params = new URLSearchParams();
    
    const pcId = document.getElementById('pcFilter').value;
    const level = document.getElementById('levelFilter').value;
    const limit = document.getElementById('limitFilter').value;
    const search = document.getElementById('searchFilter').value;
    
    if (pcId) params.append('pc_id', pcId);
    if (level) params.append('level', level);
    params.append('limit', limit);
    params.append('offset', page * parseInt(limit));
    
    fetch(`/api/logs?${params.toString()}`)
        .then(response => response.json())
        .then(logs => {
            displayLogs(logs, search);
            document.getElementById('logCount').textContent = `${logs.length} registros`;
        })
        .catch(error => {
            console.error('Error cargando logs:', error);
            document.getElementById('logsContainer').innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error cargando logs: ${error.message}
                </div>
            `;
        });
}

function displayLogs(logs, searchTerm = '') {
    const container = document.getElementById('logsContainer');
    
    if (logs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search fa-2x text-muted mb-2"></i>
                <p class="text-muted">No se encontraron logs con los filtros aplicados</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive">';
    html += '<table class="table table-sm table-hover">';
    html += `
        <thead class="table-dark sticky-top">
            <tr>
                <th width="15%">Fecha/Hora</th>
                <th width="8%">Nivel</th>
                <th width="12%">Logger</th>
                <th width="15%">PC</th>
                <th width="45%">Mensaje</th>
                <th width="5%">Acciones</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    logs.forEach(log => {
        let message = log.message;
        
        // Resaltar término de búsqueda
        if (searchTerm && message.toLowerCase().includes(searchTerm.toLowerCase())) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            message = message.replace(regex, '<mark>$1</mark>');
        }
        
        // Truncar mensaje si es muy largo
        if (message.length > 100) {
            message = message.substring(0, 100) + '...';
        }
        
        html += `
            <tr class="log-row" data-log-id="${log.id}">
                <td>
                    <small>${log.timestamp.replace('T', ' ').substring(0, 19)}</small>
                </td>
                <td>
                    <span class="log-level-${log.level}">${log.level}</span>
                </td>
                <td>
                    <small>${log.logger}</small>
                </td>
                <td>
                    <small title="${log.pc_id}">${log.pc_id.substring(0, 12)}...</small>
                </td>
                <td>
                    <span class="log-message" title="${log.message}">${message}</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showLogDetails(${log.id})" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function applyFilters() {
    currentPage = 0;
    loadLogs();
}

function refreshLogs() {
    loadLogs(currentPage);
}

function exportLogs() {
    const params = new URLSearchParams();
    
    const pcId = document.getElementById('pcFilter').value;
    const level = document.getElementById('levelFilter').value;
    
    if (pcId) params.append('pc_id', pcId);
    if (level) params.append('level', level);
    params.append('limit', '10000'); // Más logs para export
    
    fetch(`/api/logs?${params.toString()}`)
        .then(response => response.json())
        .then(logs => {
            // Crear CSV
            let csv = 'Timestamp,Level,Logger,PC_ID,Message,Source_File,Raw_Log\n';
            
            logs.forEach(log => {
                const row = [
                    log.timestamp,
                    log.level,
                    log.logger,
                    log.pc_id,
                    `"${log.message.replace(/"/g, '""')}"`,
                    log.source_file,
                    `"${log.raw_log.replace(/"/g, '""')}"`
                ];
                csv += row.join(',') + '\n';
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `antivirus_logs_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Error exportando logs:', error);
            alert('Error al exportar logs: ' + error.message);
        });
}

function showLogDetails(logId) {
    // Encontrar el log en los datos cargados
    const logRow = document.querySelector(`[data-log-id="${logId}"]`);
    if (!logRow) return;
    
    // Obtener datos del log (simulado - en producción sería una llamada AJAX)
    const cells = logRow.querySelectorAll('td');
    
    const content = document.getElementById('logDetailsContent');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Información General</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td>${logId}</td></tr>
                    <tr><td><strong>Timestamp:</strong></td><td>${cells[0].textContent.trim()}</td></tr>
                    <tr><td><strong>Nivel:</strong></td><td>${cells[1].textContent.trim()}</td></tr>
                    <tr><td><strong>Logger:</strong></td><td>${cells[2].textContent.trim()}</td></tr>
                    <tr><td><strong>PC ID:</strong></td><td><small>${cells[3].title || cells[3].textContent.trim()}</small></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Detalles Técnicos</h6>
                <table class="table table-sm">
                    <tr><td><strong>Archivo Fuente:</strong></td><td>-</td></tr>
                    <tr><td><strong>Parseado:</strong></td><td>Sí</td></tr>
                    <tr><td><strong>Recibido:</strong></td><td>-</td></tr>
                </table>
            </div>
        </div>
        
        <h6>Mensaje Completo</h6>
        <div class="bg-light p-3 rounded">
            <pre class="mb-0">${cells[4].title || cells[4].textContent.trim()}</pre>
        </div>
        
        <h6 class="mt-3">Log Raw</h6>
        <div class="bg-dark text-light p-3 rounded">
            <small><pre class="mb-0 text-light">Log raw no disponible en vista previa</pre></small>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
    modal.show();
}

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    
    if (autoRefreshEnabled) {
        clearInterval(autoRefreshInterval);
        autoRefreshEnabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Auto-refresh';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-success');
    } else {
        startAutoRefresh();
        autoRefreshEnabled = true;
        btn.innerHTML = '<i class="fas fa-pause"></i> Auto-refresh';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-outline-secondary');
    }
}

function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    
    autoRefreshInterval = setInterval(() => {
        if (autoRefreshEnabled) {
            refreshLogs();
        }
    }, 15000); // Refresh cada 15 segundos
}

// Filtro en tiempo real por mensaje
document.getElementById('searchFilter').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.log-row');
    
    rows.forEach(row => {
        const message = row.querySelector('.log-message').textContent.toLowerCase();
        row.style.display = message.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %}