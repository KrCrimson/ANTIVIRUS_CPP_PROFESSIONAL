// This is your Prisma schema file for PRODUCTION (PostgreSQL)
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo para dispositivos/clientes de antivirus
model AntivirusClient {
  id          String        @id @default(uuid())
  clientId    String        @unique
  hostname    String
  ip          String?
  version     String
  os          String
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now()) @db.Timestamp
  lastSeen    DateTime      @default(now()) @db.Timestamp
  
  // Relaciones
  logs        LogEntry[]
  
  @@map("antivirus_clients")
}

// Modelo para entradas de log
model LogEntry {
  id          String         @id @default(uuid())
  timestamp   DateTime       @default(now()) @db.Timestamp
  level       String         // DEBUG, INFO, WARNING, ERROR, CRITICAL
  component   String?        // Nombre del plugin/componente
  message     String
  metadata    Json?          // Datos adicionales estructurados
  
  // Relaciones
  clientId    String
  client      AntivirusClient @relation(fields: [clientId], references: [clientId])
  
  // Alertas relacionadas
  alerts      Alert[]
  
  @@map("log_entries")
  @@index([timestamp])
  @@index([level])
  @@index([clientId])
  @@index([component])
}

// Modelo para alertas generadas
model Alert {
  id          String    @id @default(uuid())
  severity    String    // LOW, MEDIUM, HIGH, CRITICAL
  title       String
  description String
  resolved    Boolean   @default(false)
  createdAt   DateTime  @default(now()) @db.Timestamp
  resolvedAt  DateTime? @db.Timestamp
  
  // Relación con log que generó la alerta
  logId       String
  log         LogEntry  @relation(fields: [logId], references: [id])
  
  @@map("alerts")
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
}

// Modelo para estadísticas agregadas
model LogStatistics {
  id          String   @id @default(uuid())
  date        DateTime @db.Date
  hour        Int
  clientId    String
  level       String
  component   String?
  count       Int      @default(1)
  
  @@map("log_statistics")
  @@unique([date, hour, clientId, level, component])
  @@index([date])
  @@index([clientId])
}